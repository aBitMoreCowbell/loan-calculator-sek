<!DOCTYPE html>
a.addEventListener('input',()=>{b.value=a.value; setRangeFill(b); compute();});
b.addEventListener('input',()=>{a.value=b.value; setRangeFill(b); compute();});
}


function pmt(r, n, pv){ if(r===0) return pv/n; const r1=Math.pow(1+r,n); return (pv*r*r1)/(r1-1); }


function buildSchedule(pv, r_m, n_m, fee){
const rows=[]; let bal=pv; const base=pmt(r_m,n_m,pv);
for(let i=1;i<=n_m;i++){
const interest=bal*r_m; let principal=base-interest; if(i===n_m) principal=bal; bal=Math.max(0, bal-principal);
rows.push({i, interest, principal, fee, payment: base+fee, balance: bal});
}
return {rows, base};
}


function irrMonthly(cfs,maxIter=100,tol=1e-7){
const npv=(r)=>cfs.reduce((acc,cf,t)=>acc+cf/Math.pow(1+r,t),0);
let lo=-0.9999, hi=1.0; let fLo=npv(lo), fHi=npv(hi);
if(fLo*fHi>0){ hi=5.0; fHi=npv(hi); if(fLo*fHi>0) return NaN; }
for(let k=0;k<maxIter;k++){ const mid=(lo+hi)/2, f=npv(mid); if(Math.abs(f)<tol) return mid; if(fLo*f<0){hi=mid; fHi=f;} else {lo=mid; fLo=f;} }
return (lo+hi)/2;
}


function compute(){
const A=parseInt(amount.value||0);
const Y=parseInt(years.value||0);
const N=Y*12;
const r=parseFloat(rate.value||0)/100/12;
const avi=Math.max(0, parseFloat(monthlyFee.value||0));
const setup=Math.max(0, parseFloat(setupFee.value||0));


const principal= financeSetup.checked ? (A + setup) : A;
const {rows, base}=buildSchedule(principal, r, N, avi);
const totalPay = rows.reduce((s,r)=>s+r.payment,0);
const totalInterest = rows.reduce((s,r)=>s+r.interest,0);
const totalFees = rows.reduce((s,r)=>s+r.fee,0) + (financeSetup.checked?0:setup);
const totalCost = totalInterest + totalFees;


const cf0 = financeSetup.checked ? A : (A - setup);
const cashflows=[cf0, ...rows.map(r=>-(r.payment))];
const r_m = irrMonthly(cashflows);
const apr = (isFinite(r_m)&&!isNaN(r_m)) ? (Math.pow(1+r_m,12)-1) : NaN;


monthlyOut.textContent = fmtSEK0.format(base + avi);
aprOut.textContent = isFinite(apr) ? fmtPct.format(apr) : '–';
totalRepayOut.textContent = fmtSEK0.format(totalPay);
totalCostOut.textContent = fmtSEK0.format(totalCost);


// schedule preview 12 rows by default
renderSchedule(rows, 12);


// Update narrative
const d=new Date();
const dateStr=d.toLocaleDateString('sv-SE');
const yrsStr=Y+ (Y===1?' år':' år');
howWeCalc.innerHTML = `Vid ett kreditbelopp om ${fmtSEK0.format(A)} med en rörlig årsränta på ${parseFloat(rate.value).toFixed(2).replace('.',',')} % och ${yrsStr} löptid (återbetalningstid) beräknas den effektiva räntan till ${isFinite(apr)?fmtPct.format(apr):'–'}. I exemplet ingår administrationsavgift om ${fmtSEK0.format(avi)} per månad och uppläggningsavgift om ${fmtSEK0.format(setup)} ${financeSetup.checked?'som finansieras i lånet':'som betalas vid start'}. Det ordinarie månadsbeloppet att betala är ${fmtSEK0.format(base+avi)} och det sammanlagda beloppet att betala blir ${fmtSEK0.format(totalPay)} fördelat på ${N} avbetalningar. Exemplet är beräknat ${dateStr}, förutsätter att ränta och avgifter är oförändrade under hela kreditperioden. Avrundning till närmaste krona.`;


setRangeFill(amountRange); setRangeFill(yearsRange);
return {rows};
}


function renderSchedule(rows, limit){
const n=rows.length; const showAll = limit>=n; scheduleBody.innerHTML='';
for(let i=0;i<(showAll?n:Math.min(limit,n));i++){
const r=rows[i];
const tr=document.createElement('tr');
tr.innerHTML=`<td class="py-2 pr-4">${r.i}</td>
<td class="py-2 pr-4 text-right">${fmtSEK0.format(r.interest)}</td>
<td class="py-2 pr-4 text-right">${fmtSEK0.format(r.principal)}</td>
<td class="py-2 pr-4 text-right">${fmtSEK0.format(r.fee)}</td>
<td class="py-2 pr-4 text-right">${fmtSEK0.format(r.payment)}</td>
<td class="py-2 pr-4 text-right">${fmtSEK0.format(r.balance)}</td>`;
scheduleBody.appendChild(tr);
}
toggleRowsBtn.textContent = showAll? 'Visa färre rader' : 'Visa alla rader';
toggleRowsBtn.dataset.showing = showAll? 'all' : 'preview';
}


function exportCSV(rows){
const header=['Månad','Ränta (kr)','Amortering (kr)','Aviavgift (kr)','Betalning (kr)','Saldo (kr)'];
const lines=[header.join(';')];
for(const r of rows){ lines.push([r.i,Math.round(r.interest),Math.round(r.principal),Math.round(r.fee),Math.round(r.payment),Math.round(r.balance)].join(';')); }
const blob=new Blob([`
•
`+lines.join('
')],{type:'text/csv;charset=utf-8;'});
const url=URL.createObjectURL(blob); const a=document.createElement('a');
a.href=url; a.download='amorteringsplan.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}


function init(){
// sensible defaults similar to screenshot
amount.value=175000; amountRange.value=175000;
years.value=5; yearsRange.value=5;
rate.value=9.67; monthlyFee.value=39; setupFee.value=499; financeSetup.checked=false;
setRangeFill(amountRange); setRangeFill(yearsRange);


sync(amount, amountRange); sync(years, yearsRange);
[rate, monthlyFee, setupFee, financeSetup].forEach(el=> el.addEventListener('input', compute));


toggleRowsBtn.addEventListener('click',()=>{
const rows=compute().rows; const state=toggleRowsBtn.dataset.showing; if(state==='all'){renderSchedule(rows,12);} else {renderSchedule(rows, rows.length);} });
exportCsvBtn.addEventListener('click',()=>exportCSV(compute().rows));


compute();
}


document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
