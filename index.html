<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ansök om lån – Lånekalkylator (SEK)</title>
  <meta name="description" content="Räkna ut ungefärlig månadskostnad för privatlån i SEK. Justera belopp, återbetalningstid, ränta och avgifter. Visar effektiv ränta, total kostnad och amorteringsplan." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --brand-bg:#d5ece8;  /* teal-ish backdrop */
      --brand-teal:#0f5a56; /* deep teal for accents */
      --track:#c6d2d7;     /* slider rail */
      --rail:#0f5a56;      /* filled rail */
    }
    .hero{background:var(--brand-bg);}  
    .pill{background:var(--brand-teal);} 
    .circle{background:var(--brand-teal);} 

    /* Range styling */
    input[type=range]{width:100%; appearance:none; height:8px; border-radius:9999px; background:linear-gradient(90deg,var(--rail) var(--filled,0%), var(--track) var(--filled,0%));}
    input[type=range]::-webkit-slider-thumb{appearance:none; height:22px; width:22px; border-radius:9999px; background:#fff; border:1px solid #cbd5e1; box-shadow:0 1px 2px rgba(0,0,0,.12);} 
    input[type=range]::-moz-range-thumb{height:22px; width:22px; border:none; border-radius:9999px; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,.12);} 
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{appearance:none; margin:0}
    .card{box-shadow:0 1px 2px rgba(0,0,0,.06);}
  </style>
</head>
<body class="bg-white text-gray-900">
  <main>
    <!-- HERO CALCULATOR -->
    <section class="hero border-b">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 py-10 sm:py-14">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-800 mb-6">Ansök om lån</h1>
        <div class="grid gap-8 lg:grid-cols-[1.2fr_0.8fr] items-center">
          <!-- Left controls -->
          <div>
            <!-- Amount -->
            <div class="mb-8">
              <div class="flex items-center justify-between">
                <label class="text-sm text-gray-700">Lånebelopp</label>
                <div class="relative">
                  <input id="amount" type="number" inputmode="numeric" class="w-36 rounded-xl border px-3 py-2 text-right bg-white" min="10000" max="300000" step="1000" />
                  <span class="absolute right-3 top-2.5 text-gray-500">kr</span>
                </div>
              </div>
              <div class="mt-3">
                <input id="amountRange" type="range" min="10000" max="300000" step="1000" />
                <div class="flex justify-between text-xs text-gray-600 mt-1"><span>10 000 kr</span><span>300 000 kr</span></div>
              </div>
            </div>

            <!-- Term -->
            <div class="mb-8">
              <div class="flex items-center justify-between">
                <label class="text-sm text-gray-700">Återbetalningstid</label>
                <div class="relative">
                  <input id="years" type="number" class="w-20 rounded-xl border px-3 py-2 text-right bg-white" min="2" max="15" step="1" />
                  <span class="absolute right-3 top-2.5 text-gray-500">år</span>
                </div>
              </div>
              <div class="mt-3">
                <input id="yearsRange" type="range" min="2" max="15" step="1" />
                <div class="flex justify-between text-xs text-gray-600 mt-1"><span>2 år</span><span>15 år</span></div>
              </div>
            </div>

            <!-- Rates & fees -->
            <div class="grid sm:grid-cols-3 gap-4 mb-6">
              <label class="block">
                <span class="text-sm text-gray-700">Ränta (nom. p.a.)</span>
                <div class="mt-1 relative">
                  <input id="rate" type="number" step="0.01" min="1" max="30" class="w-full rounded-xl border px-3 py-2 text-right bg-white" />
                  <span class="absolute right-3 top-2.5 text-gray-500">%</span>
                </div>
              </label>
              <label class="block">
                <span class="text-sm text-gray-700">Aviavgift</span>
                <div class="mt-1 relative">
                  <input id="monthlyFee" type="number" step="1" min="0" class="w-full rounded-xl border px-3 py-2 text-right bg-white" />
                  <span class="absolute right-3 top-2.5 text-gray-500">kr/mån</span>
                </div>
              </label>
              <label class="block">
                <span class="text-sm text-gray-700">Uppläggningsavgift</span>
                <div class="mt-1 relative">
                  <input id="setupFee" type="number" step="1" min="0" class="w-full rounded-xl border px-3 py-2 text-right bg-white" />
                  <span class="absolute right-3 top-2.5 text-gray-500">kr</span>
                </div>
              </label>
            </div>
            <label class="inline-flex items-center gap-2 text-sm text-gray-700 mb-6">
              <input id="financeSetup" type="checkbox" class="rounded border-gray-300"> 
              <span>Finansiera uppläggningsavgiften i lånet</span>
            </label>

            <div>
              <button id="applyBtn" class="pill text-white px-6 py-3 rounded-full font-semibold shadow">Börja ansökan</button>
            </div>
          </div>

          <!-- Right circle result -->
          <div class="flex items-center justify-center">
            <div class="circle w-56 h-56 sm:w-64 sm:h-64 rounded-full flex flex-col items-center justify-center text-white select-none">
              <div class="text-sm opacity-90">Månadskostnad</div>
              <div id="monthlyOut" class="text-3xl sm:text-4xl font-extrabold tracking-tight">–</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- EXPLANATION + LINKS -->
    <section class="max-w-6xl mx-auto px-4 sm:px-6 py-10">
      <h2 class="text-xl font-semibold mb-3">Så här räknar vi</h2>
      <p id="howWeCalc" class="text-sm leading-6 text-gray-700"></p>

      <div class="mt-6 grid md:grid-cols-3 gap-4">
        <div class="card rounded-2xl border p-4">
          <div class="text-xs text-gray-500">Effektiv ränta (estimat)</div>
          <div id="aprOut" class="text-xl font-semibold">–</div>
        </div>
        <div class="card rounded-2xl border p-4">
          <div class="text-xs text-gray-500">Totalt att betala</div>
          <div id="totalRepayOut" class="text-lg font-medium">–</div>
        </div>
        <div class="card rounded-2xl border p-4">
          <div class="text-xs text-gray-500">Total kostnad (ränta+avg.)</div>
          <div id="totalCostOut" class="text-lg font-medium">–</div>
        </div>
      </div>

      <details class="mt-6">
        <summary class="cursor-pointer text-teal-700 underline">Visa amorteringsplan (förhandsvisning)</summary>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead class="text-gray-500">
              <tr>
                <th class="text-left py-2 pr-4">#</th>
                <th class="text-right py-2 pr-4">Ränta</th>
                <th class="text-right py-2 pr-4">Amortering</th>
                <th class="text-right py-2 pr-4">Aviavg.</th>
                <th class="text-right py-2 pr-4">Betalning</th>
                <th class="text-right py-2 pr-4">Saldo</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="toggleRowsBtn" class="rounded-xl border px-3 py-1.5 text-sm">Visa alla rader</button>
          <button id="exportCsvBtn" class="rounded-xl border px-3 py-1.5 text-sm">Exportera CSV</button>
        </div>
      </details>

      <p class="text-xs text-gray-500 mt-8">Detta är en oberoende demokalkylator. Resultatet är ungefärligt och kan avvika efter kreditprövning.</p>
    </section>
  </main>

    <script>
    // ---- selectors
    const $ = (id) => document.getElementById(id);
    const amount = $("amount"), amountRange = $("amountRange");
    const years = $("years"), yearsRange = $("yearsRange");
    const rate = $("rate"), monthlyFee = $("monthlyFee");
    const setupFee = $("setupFee"), financeSetup = $("financeSetup");
  
    const monthlyOut = $("monthlyOut");
    const aprOut = $("aprOut");
    const totalCostOut = $("totalCostOut");
    const totalRepayOut = $("totalRepayOut");
    const howWeCalc = $("howWeCalc");
    const scheduleBody = $("scheduleBody");
    const toggleRowsBtn = $("toggleRowsBtn");
    const exportCsvBtn = $("exportCsvBtn");
  
    const fmtSEK0 = new Intl.NumberFormat("sv-SE", {style:"currency", currency:"SEK", maximumFractionDigits:0});
    const fmtSEK  = new Intl.NumberFormat("sv-SE", {style:"currency", currency:"SEK"});
    const fmtPct  = new Intl.NumberFormat("sv-SE", {style:"percent", minimumFractionDigits:2, maximumFractionDigits:2});
  
    // Fill slider track
    function setRangeFill(range){
      if(!range) return;
      const min = parseFloat(range.min), max = parseFloat(range.max), val = parseFloat(range.value);
      const pct = ((val - min) / (max - min)) * 100;
      range.style.setProperty("--filled", pct + "%");
    }
  
    // Pair a number input with its range slider
    function sync(a, b){
      a.addEventListener("input", () => { b.value = a.value; setRangeFill(b); compute(); });
      b.addEventListener("input", () => { a.value = b.value; setRangeFill(b); compute(); });
    }
  
    // Annuity payment (per month) excluding fees
    function pmt(r, n, pv){
      if (r === 0) return pv / n;
      const r1 = Math.pow(1 + r, n);
      return (pv * r * r1) / (r1 - 1);
    }
  
    // Build schedule using *unrounded* base payment; we show rounded monthly to user
    function buildSchedule(principal, r_m, n_m, fee){
      const rows = [];
      let bal = principal;
      const base = pmt(r_m, n_m, principal); // exclude fee
      for (let i = 1; i <= n_m; i++){
        const interest = bal * r_m;
        let principalPart = base - interest;
        if (i === n_m) principalPart = bal; // clear rounding residue
        bal = Math.max(0, bal - principalPart);
        rows.push({ i, interest, principal: principalPart, fee, payment: base + fee, balance: bal });
      }
      return { rows, base };
    }
  
    // IRR on monthly flows (bisection)
    function irrMonthly(cfs, maxIter=100, tol=1e-7){
      const npv = (r) => cfs.reduce((acc, cf, t) => acc + cf / Math.pow(1 + r, t), 0);
      let lo = -0.9999, hi = 1.0;
      let fLo = npv(lo), fHi = npv(hi);
      if (fLo * fHi > 0) { hi = 5.0; fHi = npv(hi); if (fLo * fHi > 0) return NaN; }
      for (let k = 0; k < maxIter; k++){
        const mid = (lo + hi) / 2, f = npv(mid);
        if (Math.abs(f) < tol) return mid;
        if (fLo * f < 0) { hi = mid; fHi = f; } else { lo = mid; fLo = f; }
      }
      return (lo + hi) / 2;
    }
  
    function compute(){
      // Read UI
      const A     = parseInt(amount.value || 0, 10);            // credit amount
      const Y     = parseInt(years.value || 0, 10);             // years
      const N     = Y * 12;                                     // months
      const rNom  = parseFloat(rate.value || 0);                // nominal p.a. %
      const r_m   = rNom / 100 / 12;                            // monthly rate
      const avi   = Math.max(0, parseFloat(monthlyFee.value || 0));
      const setup = Math.max(0, parseFloat(setupFee.value || 0));
      const pv    = financeSetup.checked ? (A + setup) : A;     // finance setup fee or not
  
      // Schedule & totals (using unrounded base, we round user-facing monthly up)
      const { rows, base } = buildSchedule(pv, r_m, N, avi);
      const monthlyShown = Math.ceil(base + avi);               // round UP to next krona
      monthlyOut.textContent = fmtSEK0.format(monthlyShown);
  
      // Totals (sum of rounded monthly payments)
      const totalPayRounded = monthlyShown * N;                 // what the user actually pays if rounded each month
      const totalInterest = rows.reduce((s, r) => s + r.interest, 0);
      const totalFees = rows.reduce((s, r) => s + r.fee, 0) + (financeSetup.checked ? 0 : setup);
      const totalCost = totalInterest + totalFees;
  
      totalRepayOut && (totalRepayOut.textContent = fmtSEK0.format(totalPayRounded));
      totalCostOut && (totalCostOut.textContent = fmtSEK0.format(totalCost));
  
      // APR via IRR (use rounded monthly outflows)
      const cf0 = financeSetup.checked ? A : (A - setup);       // net disbursement at t=0
      const cfs = [cf0, ...Array.from({length:N}, () => -monthlyShown)];
      const rMonth = irrMonthly(cfs);
      const apr = (isFinite(rMonth) && !isNaN(rMonth)) ? (Math.pow(1 + rMonth, 12) - 1) : NaN;
      aprOut && (aprOut.textContent = isFinite(apr) ? fmtPct.format(apr) : "–");
  
      // Narrative
      const d = new Date();
      const yrsStr = `${Y} år`;
      if (howWeCalc) {
        howWeCalc.innerHTML =
          `Vid ett kreditbelopp om ${fmtSEK0.format(A)} med en rörlig årsränta på ${rNom.toFixed(2).replace('.', ',')} % och ${yrsStr} ` +
          `löptid (återbetalningstid) beräknas den effektiva räntan till ${isFinite(apr) ? fmtPct.format(apr) : "–"}. ` +
          `I exemplet ingår administrationsavgift om ${fmtSEK0.format(avi)} per månad och uppläggningsavgift om ${fmtSEK0.format(setup)} ` +
          `${financeSetup.checked ? "som finansieras i lånet" : "som betalas vid start"}. ` +
          `Det ordinarie månadsbeloppet att betala är ${fmtSEK0.format(monthlyShown)} och det sammanlagda beloppet att betala blir ` +
          `${fmtSEK0.format(totalPayRounded)} fördelat på ${N} avbetalningar. Exemplet är beräknat ` +
          `${d.toLocaleDateString("sv-SE")}, förutsätter att ränta och avgifter är oförändrade under hela kreditperioden. ` +
          `Avrundning till närmaste högre krona.`;
      }
  
      // Render schedule preview (first 12 rows) using unrounded base payment
      if (scheduleBody) {
        const limit = 12;
        const show = Math.min(rows.length, limit);
        scheduleBody.innerHTML = "";
        for (let i = 0; i < show; i++){
          const r = rows[i];
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="py-2 pr-4">${r.i}</td>
            <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.interest)}</td>
            <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.principal)}</td>
            <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.fee)}</td>
            <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.payment)}</td>
            <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.balance)}</td>`;
          scheduleBody.appendChild(tr);
        }
        if (toggleRowsBtn) {
          toggleRowsBtn.onclick = () => {
            scheduleBody.innerHTML = "";
            rows.forEach(r => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td class="py-2 pr-4">${r.i}</td>
                <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.interest)}</td>
                <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.principal)}</td>
                <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.fee)}</td>
                <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.payment)}</td>
                <td class="py-2 pr-4 text-right">${fmtSEK0.format(r.balance)}</td>`;
              scheduleBody.appendChild(tr);
            });
          };
        }
        if (exportCsvBtn) {
          exportCsvBtn.onclick = () => {
            const header = ['Månad','Ränta (kr)','Amortering (kr)','Aviavgift (kr)','Betalning (kr)','Saldo (kr)'];
            const lines = [header.join(';')];
            for (const r of rows) {
              lines.push([r.i, Math.round(r.interest), Math.round(r.principal), Math.round(r.fee), Math.round(r.payment), Math.round(r.balance)].join(';'));
            }
            const blob = new Blob([`\ufeff` + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'amorteringsplan.csv';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
          };
        }
      }
  
      // keep sliders filled
      setRangeFill(amountRange); setRangeFill(yearsRange);
    }
  
    // ---- init defaults + listeners
    document.addEventListener("DOMContentLoaded", () => {
      // sensible defaults similar to your example
      amount.value = 175000; amountRange.value = 175000;
      years.value = 5; yearsRange.value = 5;
      rate.value = 9.67; monthlyFee.value = 39; setupFee.value = 499; financeSetup.checked = false;
  
      sync(amount, amountRange);
      sync(years, yearsRange);
      [rate, monthlyFee, setupFee, financeSetup].forEach(el => el.addEventListener("input", compute));
  
      setRangeFill(amountRange); setRangeFill(yearsRange);
      compute();
    });
  </script>
</body>
</html>
